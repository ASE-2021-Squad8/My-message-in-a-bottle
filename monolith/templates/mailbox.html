<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<style>
	/* The Modal (background) */
	.modal {
		display: none;
		/* Hidden by default */
		position: fixed;
		/* Stay in place */
		z-index: 1;
		/* Sit on top */
		left: 0;
		top: 0;
		width: 100%;
		/* Full width */
		height: 100%;
		/* Full height */
		overflow: auto;
		/* Enable scroll if needed */
		background-color: rgb(0, 0, 0);
		/* Fallback color */
		background-color: rgba(0, 0, 0, 0.4);
		/* Black w/ opacity */
	}

	/* Modal Content/Box */
	.modal-content {
		background-color: #fefefe;
		text-align: left;
		margin: 15% auto;
		/* 15% from the top and centered */
		padding: 20px;
		border: 1px solid #888;
		width: 80%;
		/* Could be more or less, depending on screen size */
	}

	/* The Close Button */
	.close {
		color: #aaa;
		text-align: right;
		float: right;
		font-size: 28px;
		font-weight: bold;
	}

	.close:hover,
	.close:focus {
		color: black;
		text-decoration: none;
		cursor: pointer;
	}
</style>

<div id="myModal" class="modal">
	<div class="modal-content">
		<span class="close">&times;</span>
		<div id="modal_text">
			<p>Some text in the Modal..</p>
		</div>
	</div>
</div>

<h1>Mailbox</h1>
<meta http-equiv="refresh" content="60">

<a href="/" type="button">Home</a><br><br>

<h3>Received messages</h3>
<table class="table table-striped" id="received">
	<thead class="thead-dark">
		<tr class="bg-info">
			<th class="text-center" scope="col">Sender</th>
			<th class="text-center" scope="col">E-mail</th>
			<th class="text-center" scope="col">Open message</th>
			<th class="text-center" scope="col">Reply to message</th>
			<th class="text-center" scope="col">Forward message</th>
			<th class="text-center" scope="col">Delete message for me</th>
		</tr>
	</thead>
</table><br>


<h3>Sent messages</h3>
<table class="table table-striped" id="sent">
	<thead class="thead-dark">
		<tr class="bg-info"></tr>
		<th class="text-center">Receiver</th>
		<th class="text-center">E-mail</th>
		<th class="text-center">Open message</th>
		<th class="text-center">Forward message</th>
		</tr>
	</thead>
</table>

<script>

	function get_recipient() {
		$.ajax({
			url: "/user/get_recipients",
			contentType: "application/json",
			dataType: "json",
			success: function (data, status) {
				console.log("status " + status);
				items = data;
				$.each(items, function (i, item) {
					$('#recipient').append($('<option>', {
						value: item.id,
						text: item.email
					}));
				});
				loaded = true;
			},
			error: function (a, b, c) {
				console.log(a + " " + b + " " + c)
			}
		});
	}

	function deleteMessage(message_id) {
		console.log(message_id);
		$.ajax({
			url: 'http://127.0.0.1:5000/api/message/delete/' + message_id,
			type: 'DELETE',
			success: function () {
				alert("Message deleted");
				location.reload(true);
			},
		});
	}

	function send_msg_reply_forward(form_id) {
		let inputform = $('#' + form_id).serializeArray();
		console.log(inputform);
		let inputdata = {};
		inputform.forEach(function (item) {
			inputdata[item["name"]] = item["value"];
		});
		console.log(inputdata);
		$.ajax({
			url: "/api/message/send_message",
			dataType: "html",
			data: jQuery.param(inputdata),
			type: "post",
			success: function () {
				alert("Message forwarded successfully");
			},
			error: function (a, b, c) {
				console.log(a + " " + b + " " + c);
				alert("Oops, something went wrong");
			}
		});
	}

	function open_message(msg_id, msg_text) {
		console.log(msg_id + " " + msg_text)
		url = '/api/message/read_message/' + msg_id;
		$.get('http://127.0.0.1:5000' + url);
		open_modal(msg_text);
	}

	$.get('http://127.0.0.1:5000/api/message/received', function (data) {
		buildTableReceived(data);
	});

	function buildTableReceived(data) {
		var table = document.getElementById('received');
		for (var i = 0; i < data.length; i++) {
			msg = JSON.parse(data[i]);
			console.log(msg);
			var row = `<tr>
							<td style="text-align:center">${msg.firstname + " " + msg.lastname}</td>
                            <td style="text-align:center">${msg.email}</tb>
							<td style="text-align:center"><button onclick="open_message(${msg.id_message}, '${msg.text}')" class="btn btn-success">Open</button></td>
							<td style="text-align:center">
								<button id="reply" class="btn btn-primary" onclick="">Reply</button>
								<div id="popup-reply" class="modal">
									<div class="modal-content">
										<span class="close">&times;</span>
										<h2>Reply to message</h2>
										<form method="POST" id="reply-form">
											<input type="hidden" id="draft_id" name="draft_id" value=''>
											<label for="recipient">Recipient</label><br>
											<select name="recipient">
												<option value="${msg.sender_id}" selected>${msg.email}</option>
											</select><br><br>
											<label for="text">Message text</label><br>
											<textarea id="text" name="text" required></textarea><br><br>
											<label for="delivery_date">Choose a time for delivering message</label><br>
											<input type="datetime-local" id="delivery_date" name="delivery_date" required/><br><br>
											<button type="button" onclick='javascript:send_msg_reply_forward("reply-form")' class="btn btn-primary">Send message</button>
										</form>
									</div>
								</div>
							</td>
							<td style="text-align:center">
								<button id="forward-rec" class="btn btn-primary">Forward</button>
								<div id="popup-forward" class="modal">
									<div class="modal-content">
										<span class="close">&times;</span>
										<h2>Forward message</h2>
										<form method="POST" id="forward-form-rec">
											<input type="hidden" name="draft_id" value=''>
											<label for="recipient">Recipient</label><br>
											<select id="recipient" name="recipient"></select><br><br>
											<label for="text">Message text</label><br>
											<textarea id="text" name="text" readonly>''${msg.text}'' - forwarded from ${msg.email}</textarea><br><br>
											<label for="delivery_date">Choose a time for delivering message</label><br>
											<input type="datetime-local" id="delivery_date" name="delivery_date" required/><br><br>
											<button type="button" onclick='javascript:send_msg_reply_forward("forward-form-rec")' class="btn btn-primary">Send message</button>
										</form>
									</div>
								</div>
							</td>
							<td style="text-align:center"><input type="button" value="Delete" onclick="deleteMessage(${msg.id_message})" class="btn btn-danger" /></td>
					  </tr>`;
			table.innerHTML += row;

		}
		// var modal = document.getElementById("myModal");
		// var btnReply = document.getElementById("reply");
		// var spanReply = document.getElementsByClassName("close")[0];
		// btnReply.onclick = function () {
		// 	$('#recipient').empty()
		// 	get_recipient();
		// 	modalReply.style.display = "block";
		// }
		// spanReply.onclick = function () {
		// 	modalReply.style.display = "none";
		// }
		// window.onclick = function(event) {
		// 	if (event.target == modalReply) {
		// 		modalReply.style.display = "none";
		// 	}
		// }
		// var modalForward = document.getElementById("popup-forward");
		// var btnForward = document.getElementById("forward-rec");
		// var spanForward = document.getElementsByClassName("close")[1];
		// btnForward.onclick = function () {
		// 	$('#recipient').empty()
		// 	get_recipient();
		// 	modalForward.style.display = "block";
		// }
		// spanForward.onclick = function () {
		// 	modalForward.style.display = "none";
		// }
		// window.onclick = function(event) {
		// 	if (event.target == modalForward) {
		// 		modalForward.style.display = "none";
		// 	}
		// }
	}

	$.get('http://127.0.0.1:5000/api/message/sent', function (data) {
		buildTableSent(data);
	});

	function buildTableSent(data) {
		var table = document.getElementById('sent');
		for (var i = 0; i < data.length; i++) {
			msg = JSON.parse(data[i]);
			console.log(msg);

			var row = `<tr>
							<td style="text-align:center">${msg.firstname + " " + msg.lastname}</td>
                            <td style="text-align:center">${msg.email}</tb>
								<td style="text-align:center"><button onclick="open_message(${msg.id_message}, '${msg.text}')" class="btn btn-success">Open</button></td>
							<td style="text-align:center">
								<button id="forward-sent" class="btn btn-primary">Forward</button>
								<div id="popup-forward" class="modal">
									<div class="modal-content">
										<span class="close">&times;</span>
										<h2>Forward message</h2>
										<form method="POST">
											<label for="recipient">Recipient</label><br>
											<input type="text" id="recipient"/><br><br>
											<label for="text">Message text</label><br>
											<input type="textarea" id="text" value="''${msg.text}'' - forwarded from ${msg.email}" readonly/><br><br>
											<label for="delivery_date">Choose a time for delivering message</label><br>
											<input type="datetime-local" id="delivery_date" name="delivery_date" /><br><br>
											<button type="button" onclick='javascript:send_msg_reply_forward("forward-form-sent")' class="btn btn-primary">Send message</button>
										</form>
									</div>
								</div>
							</td>
					  </tr>`;
			table.innerHTML += row;

		}
		// var modal = document.getElementById("popup-forward");
		// var btn = document.getElementById("forward-sent");
		// var span = document.getElementsByClassName("close")[2];
		// btn.onclick = function () {
		// 	$('#recipient').empty()
		// 	get_recipient();
		// 	modal.style.display = "block";
		// }
		// span.onclick = function () {
		// 	modal.style.display = "none";
		// }
		// window.onclick = function(event) {
		// 	if (event.target == modal) {
		// 		modal.style.display = "none";
		// 	}
		// }
	}

	var modal = document.getElementById("myModal");
	var modal_text = document.getElementById("modal_text");
	var btn = document.getElementById("myBtn");

	var span = document.getElementsByClassName("close")[0];

	function open_modal(text) {
		//console.log(text)
		modal.style.display = "block";
		//console.log(modal)
		modal_text.textContent = text;
	}

	span.onclick = function () {
		modal.style.display = "none";
	}

	// When the user clicks anywhere outside of the modal, close it
	window.onclick = function (event) {
		if (event.target == modal) {
			modal.style.display = "none";
		}
	}

</script>